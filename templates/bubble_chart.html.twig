{% set yCount = 1 %}

<canvas id="bubble_chart" height="300" width ="300"></canvas>
<script>
    var timeFormat = 'YYYY-MM-DD h:mm a';
    var bubble_chart = new Chart(document.getElementById("bubble_chart"), {
        type: 'bubble',
        data: {
            files: [
                {% for file in filteredFiles %}
                    {% for func in file.getFunctions() %}
                        {% for commit in func.getCommits() %}
                            "{{ file.getName() }}-{{ func.getCurrentName()}}-{{ commit.getSize() }}",
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            ],
            datasets: [
                {% for file in filteredFiles %}
                    {% for func in file.getFunctions() %}
                        {% for commit in func.getCommits() %}
                            {
                                label: "{{ func.getCurrentName() }}",
                                data:
                                    [{
                                            x: moment("{{ commit.getCommitDate().format('Y-m-d h') }}").format(timeFormat),
                                            y: {{ yCount }},
                                            r: 3 + {{ commit.getSize() }}*0.05
                                    }],
                                fill:false,
                                borderColor:"{{ colours[file.getName()][1] }}",
                                backgroundColor:"{{ colours[file.getName()][0] }}"
                            },
                        {% endfor %}
                    {% set yCount = yCount + 1 %}
                    {% endfor %}
                {% endfor %}
            ]
        },
        options: {
            title: {
                display: true,
                text: "Function Lifespan"
            },
            scales: {
                yAxes: [
                    {
                    scaleLabel: {
                        display: true,
                        labelString: "Functions",
                        fontSize: 18

                    },

                    ticks: {
                        min: 0,
                        max: {{ yCount }},
                        stepSize: 1,
                        fontSize:10,
                        callback: function(label, index, labels) {
                            var functions = [
                                {% for func in functions %}
                                    "{{ func }}",
                                {% endfor %}
                            ];
                            if (label == 0) {
                                return ""
                            }
                            return functions[label-1]
                        }
                    }
                }],
                xAxes: [{
                    type: 'time',
                    time: {
                        format: timeFormat,
                        unit: 'day',
                        max: moment("{{endDate}}").format(timeFormat),
                        min: moment("{{startDate}}").format(timeFormat),
                    },
                    scaleLabel: {
                        display: true,
                        labelString: "Time",
                        fontSize: 18
                    },
                    gridLines: {
                        display: false
                    }
                }]
            },
            legend: {
                display: false
            },
            tooltips: {
                callbacks: {
                    beforeLabel: function(tooltipItem, data) {
                        return data['files'][tooltipItem['datasetIndex']].split("-")[1] + "( )";
                    },
                    label: function(tooltipItem, data) {
                        return "Parent file: " + data['files'][tooltipItem['datasetIndex']].split("-")[0];
                    },
                    afterLabel: function(tooltipItem, data) {
                        var lines = data['files'][tooltipItem['datasetIndex']].split("-")[2];
                        if (lines === '0') {
                            return "DELETED"
                        } else {
                            return "# of lines: " + data['files'][tooltipItem['datasetIndex']].split("-")[2];
                        }
                    }
                },
                backgroundColor: 'rgba(240,248,255, 0.9)',
                bodyFontColor: '#586062',
                bodyFontSize: 14,
                displayColors: false
            },
            legendCallback: function(chart) {
                var backgroundColours = [
                    {% for file in files %}
                    "{{ colours[file.getName()][0] }}",
                    {% endfor %}
                ];

                var borderColours = [
                    {% for file in files %}
                    "{{ colours[file.getName()][1] }}",
                    {% endfor %}
                ];

                var files = [
                    {% for file in files %}
                    "{{ file.getName() }}",
                    {% endfor %}
                ];

                var text = [];
                for (var i=0; i<files.length; i++) {
                    text.push('<span style="background-color: '+backgroundColours[i]+'; border: 2px solid '+ borderColours[i] +';"></span>');
                    text.push('<sub>' + files[i] + '</sub>');
                }
                return text.join("");
            }


        }
    });
</script>